import csv
import datetime
from typing import Dict, List


class TaskManager:
    def __init__(self):
        self.tasks = {}
        self.suggested_tasks = [
            {"name": "Утренняя зарядка", "priority": 2, "deadline": "", "status": "Не начато"},
            {"name": "Поход в спортзал", "priority": 2, "deadline": "", "status": "Не начато"},
            {"name": "Ведение дневника", "priority": 1, "deadline": "", "status": "Не начато"},
            {"name": "Чтение книги", "priority": 1, "deadline": "", "status": "Не начато"}
        ]

    def add_task(self, name: str, priority: int, deadline: str):
        self.tasks[name] = {
            "name": name,
            "priority": priority,
            "deadline": deadline,
            "status": "Не начато"
        }
        print(f"Задача '{name}' добавлена")

    def remove_task(self, name: str):
        if name in self.tasks:
            del self.tasks[name]
            print(f"Задача '{name}' удалена")
        else:
            print(f"Задача '{name}' не найдена")

    def update_status(self, name: str, status: str):
        if name in self.tasks:
            if status in ["В работе", "Завершено"]:
                self.tasks[name]["status"] = status
                print(f"Статус задачи '{name}' изменен на '{status}'")
            else:
                print("Недопустимый статус. Используйте 'В работе' или 'Завершено'")
        else:
            print(f"Задача '{name}' не найдена")

    def sort_by_priority(self):
        return sorted(self.tasks.values(), key=lambda x: x["priority"], reverse=True)

    def sort_by_deadline(self):
        return sorted(self.tasks.values(), key=lambda x: x["deadline"] if x["deadline"] else "9999-12-31")

    def save_to_csv(self, filename: str):
        with open(filename, 'w', newline='', encoding='utf-8') as file:
            writer = csv.DictWriter(file, fieldnames=["name", "priority", "deadline", "status"])
            writer.writeheader()
            for task in self.tasks.values():
                writer.writerow(task)
        print(f"Задачи сохранены в {filename}")

    def show_suggested_tasks(self):
        print("\nПредложенные задачи:")
        for task in self.suggested_tasks:
            print(f"Название: {task['name']}, Приоритет: {task['priority']}, Статус: {task['status']}")

    def add_suggested_task(self, task_name: str):
        for task in self.suggested_tasks:
            if task["name"] == task_name:
                self.add_task(task["name"], task["priority"],
                              datetime.date.today().strftime("%Y-%m-%d"))
                break
        else:
            print(f"Предложенная задача '{task_name}' не найдена")

    def check_overdue_tasks(self):
        today = datetime.date.today()
        overdue_found = False
        print("\nПросроченные задачи:")
        for task in self.tasks.values():
            if task["deadline"] and task["status"] != "Завершено":
                try:
                    deadline_date = datetime.datetime.strptime(task["deadline"], "%Y-%m-%d").date()
                    if deadline_date < today:
                        overdue_found = True
                        print(f"Название: {task['name']}, Приоритет: {task['priority']}, "
                              f"Срок: {task['deadline']}, Статус: {task['status']}")
                except ValueError:
                    print(f"Ошибка формата даты в задаче '{task['name']}'")
        if not overdue_found:
            print("Просроченных задач нет")


def main():
    manager = TaskManager()

    while True:
        print("\n=== Менеджер задач ===")
        print("1. Добавить задачу")
        print("2. Удалить задачу")
        print("3. Изменить статус")
        print("4. Показать задачи (сортировка по приоритету)")
        print("5. Показать задачи (сортировка по сроку)")
        print("6. Сохранить в CSV")
        print("7. Показать предложенные задачи")
        print("8. Добавить предложенную задачу")
        print("9. Проверить просроченные задачи")
        print("10. Выйти")

        choice = input("Выберите действие (1-10): ")

        if choice == "1":
            name = input("Введите название задачи: ")
            priority = int(input("Введите приоритет (1-5): "))
            deadline = input("Введите срок (ГГГГ-ММ-ДД) или оставьте пустым: ")
            manager.add_task(name, priority, deadline)

        elif choice == "2":
            name = input("Введите название задачи для удаления: ")
            manager.remove_task(name)

        elif choice == "3":
            name = input("Введите название задачи: ")
            status = input("Введите новый статус (В работе/Завершено): ")
            manager.update_status(name, status)

        elif choice == "4":
            print("\nЗадачи (по приоритету):")
            for task in manager.sort_by_priority():
                print(f"Название: {task['name']}, Приоритет: {task['priority']}, "
                      f"Срок: {task['deadline']}, Статус: {task['status']}")

        elif choice == "5":
            print("\nЗадачи (по сроку):")
            for task in manager.sort_by_deadline():
                print(f"Название: {task['name']}, Приоритет: {task['priority']}, "
                      f"Срок: {task['deadline']}, Статус: {task['status']}")

        elif choice == "6":
            filename = input("Введите имя файла (например, tasks.csv): ")
            manager.save_to_csv(filename)

        elif choice == "7":
            manager.show_suggested_tasks()

        elif choice == "8":
            manager.show_suggested_tasks()
            task_name = input("Введите название предложенной задачи для добавления: ")
            manager.add_suggested_task(task_name)

        elif choice == "9":
            manager.check_overdue_tasks()

        elif choice == "10":
            print("Программа завершена")
            break

        else:
            print("Неверный выбор. Попробуйте снова.")

main()
